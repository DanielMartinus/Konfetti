name: permissions
on: pull_request

jobs:
  build-master:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1
        with:
          ref: master

      - name: Build Master APK
        run: ./gradlew demo-google-play:assembleDebug

      - name: Get permissions
        run: $ANDROID_HOME/build-tools/29.0.3/aapt d permissions demo-google-play/build/outputs/apk/debug/demo-google-play-debug.apk > permissions-master.txt

      - name: Upload permissions file master
        uses: actions/upload-artifact@v1
        with:
          name: permissions
          path: permissions-master.txt

  build-branch:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v1

    - name: Build APK from current branch
      run: ./gradlew demo-google-play:assembleDebug

    - name: Get permissions
      run: $ANDROID_HOME/build-tools/29.0.3/aapt d permissions demo-google-play/build/outputs/apk/debug/demo-google-play-debug.apk > permissions-branch.txt

    - name: Upload APK
      uses: actions/upload-artifact@v1
      with:
        name: permissions
        path: permissions-branch.txt

  diff-permissions:
    needs: [build-master, build-branch]
    runs-on: ubuntu-latest
    steps:
      - name: Download permissions
        uses: actions/download-artifact@v1
        with:
          name: permissions

      - name: Execute diff
        run: diff --changed-group-format='%<%>' --unchanged-group-format='' $GITHUB_WORKSPACE/permissions/permissions-master.txt $GITHUB_WORKSPACE/permissions/permissions-branch.txt > permissions-diff.txt && echo ::set-env name=NEW_PERMISSIONS::'false' || echo ::set-env name=NEW_PERMISSIONS::'true'

      - run: printf "âš  New permission(s) found\n\n\`\`\`\n" > pr-comment.txt && cat permissions-diff.txt >> pr-comment.txt

      - name: comment PR
        if: env.NEW_PERMISSIONS == 'true'
        uses: machine-learning-apps/pr-comment@master
        env:
          GITHUB_TOKEN: ${{ secrets.personaltoken }}
        with:
          path: pr-comment.txt
