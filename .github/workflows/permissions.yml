name: permissions
on: push

jobs:
  build-master:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1
        with:
          ref: master

      - name: Build with Gradle
        run: |
          export PATH="$ANDROID_HOME/build-tools/29.0.3:$PATH"

      - name: Build Master APK
        run: ./gradlew demo-google-play:assembleDebug

      - name: Get permissions
        run: $ANDROID_HOME/build-tools/29.0.3/aapt d permissions demo-google-play/build/outputs/apk/debug/demo-google-play-debug.apk > permissions-master.txt

      - name: Upload permissions file master
        uses: actions/upload-artifact@v1
        with:
          name: permissions
          path: permissions-master.txt

  build-branch:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v1

    - name: Build with Gradle
      run: |
        export PATH="$ANDROID_HOME/build-tools/29.0.3:$PATH"

    - name: Build APK from current branch
      run: ./gradlew demo-google-play:assembleDebug

    - name: Get permissions
      run: $ANDROID_HOME/build-tools/29.0.3/aapt d permissions demo-google-play/build/outputs/apk/debug/demo-google-play-debug.apk > permissions-branch.txt

    - name: Upload APK
      uses: actions/upload-artifact@v1
      with:
        name: permissions
        path: permissions-branch.txt

  diff-permissions:
    needs: [build-master, build-branch]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1

      - name: Download permissions
        uses: actions/download-artifact@v1
        with:
          name: permissions

      - name: Execute diff
        run: diff /home/runner/work/Konfetti/Konfetti/permissions/permissions-master.txt /home/runner/work/Konfetti/Konfetti/permissions/permissions-branch.txt > permissions-diff.txt || true
